{% extends ../../../templates/base.html %}

{% block title %}[{{instance.hostname}}:{{instance.pg_port}}] - Dashboard{% end %}

{% block content %}

<div class="row mb-3">
  <div class="col-xxl-3 col-xl-4 col-12 mb-3 mb-xl-0">
    <div class="row">
      <div class="col-xl-12 col mb-xl-3">
        {% block information %}{% end %}
      </div>
      <div class="col-xl-12 col">
        <div class="row">
          <div class="col-6 small text-center">
            <div class="chart-title">
              CPU
            </div>
            <div id="total-cpu" class="text-muted">
              &nbsp;
            </div>
            <div class="card-body p-2 chart-small">
              <canvas id="chart-cpu"></canvas>
            </div>
          </div>
          <div class="col-6 small text-center">
            <div class="chart-title">
              Memory
            </div>
            <div id="total-memory" class="text-muted">
              &nbsp;
            </div>
            <div class="card-body p-2 chart-small">
              <canvas id="chart-memory"></canvas>
            </div>
          </div>
          <div class="col-6 small text-center">
            <div class="chart-title">
              Cache Hit Ratio
            </div>
            <div id="total-hit" class="text-muted">
            </div>
            <div class="card-body p-2 chart-small">
              <canvas id="chart-hitratio"></canvas>
            </div>
          </div>
          <div class="col-6 small text-center">
            <div class="chart-title">
              Sessions
            </div>
            <div id="total-sessions" class="text-muted">
            </div>
            <div class="card-body p-2 chart-small">
              <canvas id="chart-sessions"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xxl-9 col-xl-8 col-12">
    <div class="h-50 pb-3">
      <div class="card h-100">
        <div class="text-center small p-0">
          <span class="chart-title">
            TPS
          </span>
          <div class="position-absolute top-0 right-0 pr-1">Commit: <span id="tps_commit" class="badge badge-success">0</span> Rollback: <span id="tps_rollback" class="badge badge-danger">0</span></div>
        </div>
        <div class="card-body h-100 p-2">
          <div id="canvas-tps-holder" class="canvas-wrapper chart-h-min chart-h-min-xl-0">
            <canvas id="chart-tps"/>
          </div>
        </div>
      </div>
    </div>
    <div class="h-50">
      <div class="card h-100">
        <div class="text-center small p-0">
          <span class="chart-title">
            Loadaverage
          </span>
          <div class="position-absolute top-0 right-0 pr-1"><span id="loadaverage" class="badge badge-primary">{{dashboard['loadaverage']}}</span></div>
        </div>
        <div class="card-body h-100 p-2">
          <div id="canvas-loadaverage-holder" class="canvas-wrapper chart-h-min chart-h-min-xl-0">
            <canvas id="chart-loadaverage" />
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-6">
    <div class="card mb-4">
      <div class="card-header small p-1 chart-title">
        Notifications
      </div>
      <div class="card-body p-2 small" id="divNotif10">
        <div class="text-center"><div class="progress"><div class="progress-bar progress-bar-striped" style="width: 100%;">Please wait ...</div></div></div>
      </div>
    </div>
  </div>
</div>

<!-- <script src="/js/Chart.js"></script> -->
<script src="/js/Chart.min.js"></script>
<script src="/js/dashboard/temboard.dashboard.js"></script>
<script src="/js/filesize.min.js"></script>
<script>
  var memorydata = {
    labels: [ "Active", "Cached", "Free" ],
    datasets: [
      {
        data: [{{dashboard['memory']['active']}}, {{dashboard['memory']['cached']}}, {{dashboard['memory']['free']}}],
        backgroundColor: ["#cc2936", "#29cc36","#eeeeee"]
      }
    ]
  };

  var cpudata = {
    labels: ["IO Wait", "Steal", "User", "System", "IDLE"],
    datasets: [
      {
        data: [{{dashboard['cpu']['iowait']}}, {{dashboard['cpu']['steal']}}, {{dashboard['cpu']['user']}}, {{dashboard['cpu']['system']}}, {{dashboard['cpu']['idle']}}],
        backgroundColor: ["#cc2936", "#cbff00", "#29cc36", "#cbff00", "#eeeeee"]
      }
    ]
  };

  var hitratiodata = {
    labels: ["Hit", "Read"],
    datasets: [
      {
        data: [{{dashboard['hitratio']}}, {{readratio}}],
        backgroundColor: ["#29cc36", "#cc2936"]
      }
    ]
  };

  {% if not 'max_connections' in dashboard %}
  {% set free_sessions = 'NaN' %}
  {% else %}
  {% set free_sessions = dashboard['max_connections'] - dashboard['active_backends']['nb'] %}
  {% end %}

  var sessionsdata = {
    labels: ["Active backends", ""],
    datasets: [
      {
        data: [{{dashboard['active_backends']['nb']}}, {{ free_sessions }}],
        backgroundColor: ["#29cc36", "#eeeeee"]
      }
    ]
  };

  var jdata_history = JSON.parse('{% raw history %}');
  for (var p in jdata_history)
  {
    var updchart = false;
    if (p == (jdata_history.length - 1))
    {
      updchart = true;
    }
    update_tps(jdata_history[p], updchart);
    update_loadaverage(jdata_history[p], updchart);
    /*update_backends(jdata_history[p], updchart);*/
  }
  var xsession = "{{xsession}}";
  var agent_address = "{{instance.agent_address}}";
  var agent_port = "{{instance.agent_port}}";
  window.setInterval(function () {refresh_dashboard(agent_address, agent_port, xsession)}, 2000);

  $(document).ready(function() {
    $('[data-type=size]').each(function(){
      if ($(this).html() != 'None')
        $(this).html(filesize($(this).html()));
    });
  });
</script>
{% end %}

{% block information %}
        <table class="w-100 small">
        <tbody>
        {% if 'linux_distribution' in dashboard %}
        <tr>
          <th>Distribution:</th>
          <td class="text-right">{{ dashboard['linux_distribution'] }}</td>
        </tr>
        {% end %}
        <tr>
          <th>OS:</th>
          <td id="os_version" class="text-right">{{ dashboard['os_version'] }}</td>
        </tr>
        <tr>
          <th>CPU:</th>
          <td id="cpu" class="text-right">
            {% if 'cpu_models' in dashboard %}
              <ul class="list-unstyled mb-0">
                <li>
                  {% for model, count in dashboard['cpu_models'].items() %}
                  {{ count }} &times;
                  <span class="text-muted small">
                    {{ model }}
                  </span>
                </li>
              </ul>
              {% end %}
            {% else %}
              {{ dashboard['n_cpu'] }}
            {% end %}
          </td>
        </tr>
        <tr>
          <th>Memory:</th>
          <td id="memory" data-type="size" class="text-right">{{ dashboard['memory']['total'] * 1000 }}</td>
        </tr>
        <tr>
          <th>Databases:</th>
          <td class="text-right">
            <span id="nb_db">
              {{ dashboard['databases']['databases'] }}
            </span>
            <span class="text-muted">
              (<span id="size">{{ dashboard['databases']['total_size'] }}</span>)
            </span>
          </td>
        </tr>
        <tr>
          <th>Uptime:</th>
          <td id="pg_uptime" class="text-right">{{ dashboard['pg_uptime'] }}</td>
        </tr>
        </tbody>
        </table>
{% end %}
