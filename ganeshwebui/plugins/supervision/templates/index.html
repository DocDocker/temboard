{% extends ../../../templates/base.html %}

{% block title %}[{{instance.hostname}}:{{instance.pg_port}}] - Supervision{% end %}

{% block content %}
<div class="modal fade" id="Modal" tabindex="-1" role="dialog" aria-labelledby="ModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    			<h4 class="modal-title" id="ModalLabel"></h4>
    		</div>
    		<div class="modal-body" id="ModalBody">
				<img id="imageModal" width="100%"/>
      		</div>
      		<div class="modal-footer" id="ModalFooter">
        		<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
      		</div>
    	</div>
  	</div>
</div>
<div class="container-fluid">
	<div class="row">
		<div class="col-md-12">
			<h1><i class="fa fa-bar-chart-o"></i> Supervision <small>/</small> Charts <small>/</small> Last {{period}}</h1>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<h4>Loadaverage</h4>
			<div id="legendLoadavg"></div>
			<div id="chartLoadavg" class="supervision-chart"></div>
      		<div id="visibilityLoadavg"></div>
			<div class="pull-right"><button class="btn btn-primary" id="buttonExportLoadavg">Export as PNG</button></div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<h4>CPU Usage</h4>
			<div id="legendCPU"></div>
			<div id="chartCPU" class="supervision-chart"></div>
      		<div id="visibilityCPU"></div>
			<div class="pull-right"><button class="btn btn-primary" id="buttonExportCPU">Export as PNG</button></div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<h4>Memory Usage</h4>
			<div id="legendMemory"></div>
			<div id="chartMemory" class="supervision-chart"></div>
      		<div id="visibilityMemory"></div>
			<div class="pull-right"><button class="btn btn-primary" id="buttonExportMemory">Export as PNG</button></div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<h4>Swap Usage</h4>
			<div id="legendSwap"></div>
			<div id="chartSwap" class="supervision-chart"></div>
      		<div id="visibilitySwap"></div>
			<div class="pull-right"><button class="btn btn-primary" id="buttonExportSwap">Export as PNG</button></div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<h4>Transactions per second</h4>
			<div id="legendTPS"></div>
			<div id="chartTPS" class="supervision-chart"></div>
      		<div id="visibilityTPS"></div>
			<div class="pull-right"><button class="btn btn-primary" id="buttonExportTPS">Export as PNG</button></div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<h4>Database size</h4>
			<div id="legendDBSize"></div>
			<div id="chartDBSize" class="supervision-chart"></div>
      		<div id="visibilityDBSize"></div>
			<div class="pull-right"><button class="btn btn-primary" id="buttonExportDBSize">Export as PNG</button></div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<h4>Sessions</h4>
			<div id="legendSessions"></div>
			<div id="chartSessions" class="supervision-chart"></div>
      		<div id="visibilitySessions"></div>
			<div class="pull-right"><button class="btn btn-primary" id="buttonExportSessions">Export as PNG</button></div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<h4>Blocks Hit vs Read per second</h4>
			<div id="legendBlocks"></div>
			<div id="chartBlocks" class="supervision-chart"></div>
      		<div id="visibilityBlocks"></div>
			<div class="pull-right"><button class="btn btn-primary" id="buttonExportBlocks">Export as PNG</button></div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<h4>Blocks Hit vs Read ratio</h4>
			<div id="legendHRR"></div>
			<div id="chartHRR" class="supervision-chart"></div>
      		<div id="visibilityHRR"></div>
			<div class="pull-right"><button class="btn btn-primary" id="buttonExportHRR">Export as PNG</button></div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<h4>Checkpoints</h4>
			<div id="legendCheckpoints"></div>
			<div id="chartCheckpoints" class="supervision-chart"></div>
      		<div id="visibilityCheckpoints"></div>
			<div class="pull-right"><button class="btn btn-primary" id="buttonExportCheckpoints">Export as PNG</button></div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<h4>Written buffers</h4>
			<div id="legendWBuffers"></div>
			<div id="chartWBuffers" class="supervision-chart"></div>
      		<div id="visibilityWBuffers"></div>
			<div class="pull-right"><button class="btn btn-primary" id="buttonExportWBuffers">Export as PNG</button></div>
		</div>
	</div>
</div>

<script src="/js/dygraph-combined.js"></script>
<script src="/js/dygraph-extra.js"></script>
<script>
var sync_graphs = null;

$(document).ready(function() {

	var orig_xAxisRange = null;
	var c_lvg = new Dygraph(
	    document.getElementById("chartLoadavg"),
	    "/server/{{instance.agent_address}}/{{instance.agent_port}}/supervision/data/loadavg?start={{escape(start_date)}}&end={{escape(end_date)}}",
		{
			colors: ['#2d7fbf', '#bf562d', '#2dbf4c'],
			ylabel: "Loadaverage",
			axisLabelFontSize: 10,
			yLabelWidth: 14,
			legend: "always",
			labelsDiv: "legendLoadavg",
			drawCallback: function(g, is_initial) {
				if (is_initial)
				{
					orig_xAxisRange = g.xAxisRange();
				}
				add_visibility_cb("Loadavg", g, is_initial);
				add_export_button_callback("Loadavg", g, is_initial, "Loadaverage");
			},
			zoomCallback: function(minDate, maxDate, yRanges) {
				zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this, 'loadavg');
				if (this.isZoomed())
					sync_dateWindow(this, this.xAxisRange());
				else
					sync_dateWindow(this, orig_xAxisRange);
				synchronize_zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this);
			}
		}
	);
	
	var c_cpu = new Dygraph(
	    document.getElementById("chartCPU"),
	    "/server/{{instance.agent_address}}/{{instance.agent_port}}/supervision/data/cpu?start={{escape(start_date)}}&end={{escape(end_date)}}",
		{
			colors: ['#2d7fbf', '#2dbf4c', '#bf562d', '#666666'],
			ylabel: "%",
			axisLabelFontSize: 10,
			yLabelWidth: 14,
			legend: "always",
			stackedGraph: true,
			labelsKMG2: true,
			labelsDiv: "legendCPU",
			drawCallback: function(g, is_initial) {
				if (is_initial)
				{
					orig_xAxisRange = g.xAxisRange();
				}
				add_visibility_cb("CPU", g, is_initial);
				add_export_button_callback("CPU", g, is_initial, "CPU Usage");
			},
			zoomCallback: function(minDate, maxDate, yRanges) {
				zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this, 'cpu');
				if (this.isZoomed())
					sync_dateWindow(this, this.xAxisRange());
				else
					sync_dateWindow(this, orig_xAxisRange);
				synchronize_zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this);
			}
		}
	);
	
	var c_memory = new Dygraph(
	    document.getElementById("chartMemory"),
	    "/server/{{instance.agent_address}}/{{instance.agent_port}}/supervision/data/memory?start={{escape(start_date)}}&end={{escape(end_date)}}",
		{
			colors: ['#aaaaaa', '#2dbf4c', '#2d7fbf', '#223cbf'],
			ylabel: "Memory",
			axisLabelFontSize: 10,
			yLabelWidth: 14,
			legend: "always",
			stackedGraph: true,
			labelsDiv: "legendMemory",
			labelsKMG2: true,
			drawCallback: function(g, is_initial) {
				if (is_initial)
				{
					orig_xAxisRange = g.xAxisRange();
				}
				add_visibility_cb("Memory", g, is_initial);
				add_export_button_callback("Memory", g, is_initial, "Memory usage");
			},
			zoomCallback: function(minDate, maxDate, yRanges) {
				zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this, 'memory');
				if (this.isZoomed())
					sync_dateWindow(this, this.xAxisRange());
				else
					sync_dateWindow(this, orig_xAxisRange);
				synchronize_zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this);
			}
		}
	);
	
	var c_swap = new Dygraph(
	    document.getElementById("chartSwap"),
	    "/server/{{instance.agent_address}}/{{instance.agent_port}}/supervision/data/swap?start={{escape(start_date)}}&end={{escape(end_date)}}",
		{
			colors: ['#bf562d'],
			ylabel: "Memory",
			axisLabelFontSize: 10,
			yLabelWidth: 14,
			legend: "always",
			stackedGraph: true,
			labelsDiv: "legendSwap",
			labelsKMG2: true,
			drawCallback: function(g, is_initial) {
				if (is_initial)
				{
					orig_xAxisRange = g.xAxisRange();
				}
				add_visibility_cb("Swap", g, is_initial);
				add_export_button_callback("Swap", g, is_initial, "Swap usage");
			},
			zoomCallback: function(minDate, maxDate, yRanges) {
				zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this, 'swap');
				if (this.isZoomed())
					sync_dateWindow(this, this.xAxisRange());
				else
					sync_dateWindow(this, orig_xAxisRange);
				synchronize_zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this);
			}
		}
	);
	
	
	var c_tps = new Dygraph(
	    document.getElementById("chartTPS"),
	    "/server/{{instance.agent_address}}/{{instance.agent_port}}/supervision/data/tps?start={{escape(start_date)}}&end={{escape(end_date)}}",
		{
			colors: ['#2dbf4c', '#bf562d'],
			ylabel: "Transactions",
			axisLabelFontSize: 10,
			yLabelWidth: 14,
			legend: "always",
			stackedGraph: true,
			labelsDiv: "legendTPS",
			drawCallback: function(g, is_initial) {
				if (is_initial)
				{
					orig_xAxisRange = g.xAxisRange();
				}
				add_visibility_cb("TPS", g, is_initial);
				add_export_button_callback("TPS", g, is_initial, "Transactions per second");
			},
			zoomCallback: function(minDate, maxDate, yRanges) {
				zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this, 'tps');
				if (this.isZoomed())
					sync_dateWindow(this, this.xAxisRange());
				else
					sync_dateWindow(this, orig_xAxisRange);
				synchronize_zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this);
			}
		}
	);
	
	var c_dbs = new Dygraph(
	    document.getElementById("chartDBSize"),
	    "/server/{{instance.agent_address}}/{{instance.agent_port}}/supervision/data/db_size?start={{escape(start_date)}}&end={{escape(end_date)}}",
		{
			ylabel: "Size",
			axisLabelFontSize: 10,
			yLabelWidth: 14,
			legend: "always",
			stackedGraph: true,
			labelsKMG2: true,
			labelsDiv: "legendDBSize",
			drawCallback: function(g, is_initial) {
				if (is_initial)
				{
					orig_xAxisRange = g.xAxisRange();
				}
				add_visibility_cb("DBSize", g, is_initial);
				add_export_button_callback("DBSize", g, is_initial, "Database size");
			},
			
			zoomCallback: function(minDate, maxDate, yRanges) {
				zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this, 'db_size');
				if (this.isZoomed())
					sync_dateWindow(this, this.xAxisRange());
				else
					sync_dateWindow(this, orig_xAxisRange);
				synchronize_zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this);
			}
		}
	);
	
	var c_sessions = new Dygraph(
	    document.getElementById("chartSessions"),
	    "/server/{{instance.agent_address}}/{{instance.agent_port}}/supervision/data/sessions?start={{escape(start_date)}}&end={{escape(end_date)}}",
		{
			ylabel: "Sessions",
			axisLabelFontSize: 10,
			yLabelWidth: 14,
			legend: "always",
			stackedGraph: true,
			labelsDiv: "legendSessions",
			drawCallback: function(g, is_initial) {
				if (is_initial)
				{
					orig_xAxisRange = g.xAxisRange();
				}
				add_visibility_cb("Sessions", g, is_initial);
				add_export_button_callback("Sessions", g, is_initial, "Sessions");
			},
			
			zoomCallback: function(minDate, maxDate, yRanges) {
				zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this, 'sessions');
				if (this.isZoomed())
					sync_dateWindow(this, this.xAxisRange());
				else
					sync_dateWindow(this, orig_xAxisRange);
				synchronize_zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this);
			}
		}
	);
	
	var c_blocks = new Dygraph(
	    document.getElementById("chartBlocks"),
	    "/server/{{instance.agent_address}}/{{instance.agent_port}}/supervision/data/blocks?start={{escape(start_date)}}&end={{escape(end_date)}}",
		{
			colors: ['#bf562d', '#2dbf4c'],
			ylabel: "Blocks",
			axisLabelFontSize: 10,
			yLabelWidth: 14,
			legend: "always",
			labelsDiv: "legendBlocks",
			drawCallback: function(g, is_initial) {
				if (is_initial)
				{
					orig_xAxisRange = g.xAxisRange();
				}
				add_visibility_cb("Blocks", g, is_initial);
				add_export_button_callback("Blocks", g, is_initial, "Blocks Hit vs Read per second");
			},
			
			zoomCallback: function(minDate, maxDate, yRanges) {
				zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this, 'blocks');
				if (this.isZoomed())
					sync_dateWindow(this, this.xAxisRange());
				else
					sync_dateWindow(this, orig_xAxisRange);
				synchronize_zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this);
			}
		}
	);
	
	var c_hrr = new Dygraph(
	    document.getElementById("chartHRR"),
	    "/server/{{instance.agent_address}}/{{instance.agent_port}}/supervision/data/hitreadratio?start={{escape(start_date)}}&end={{escape(end_date)}}",
		{
			colors: ['#2d7fbf'],
			ylabel: "%",
			axisLabelFontSize: 10,
			yLabelWidth: 14,
			legend: "always",
			labelsDiv: "legendHRR",
			drawCallback: function(g, is_initial) {
				if (is_initial)
				{
					orig_xAxisRange = g.xAxisRange();
				}
				add_visibility_cb("HRR", g, is_initial);
				add_export_button_callback("HRR", g, is_initial, "Blocks Hit vs Read ratio");
			},
			
			zoomCallback: function(minDate, maxDate, yRanges) {
				zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this, 'hitreadratio');
				if (this.isZoomed())
					sync_dateWindow(this, this.xAxisRange());
				else
					sync_dateWindow(this, orig_xAxisRange);
				synchronize_zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this);
			}
		}
	);
	
	var c_checkpoints = new Dygraph(
	    document.getElementById("chartCheckpoints"),
	    "/server/{{instance.agent_address}}/{{instance.agent_port}}/supervision/data/checkpoints?start={{escape(start_date)}}&end={{escape(end_date)}}",
		{
			labels: [ 'Date', 'timed', 'requested', 'write_time', 'sync_time' ],
			ylabel: "Checkpoints",
			y2label: "Duration",
			axisLabelFontSize: 10,
			yLabelWidth: 14,
			y2LabelWidth: 14,
			legend: "always",
	        series: {
	              'write_time': {
	                axis: 'y2'
	              },
	              'sync_time': {
	                axis: 'y2'
	              },
	            },
			labelsDiv: "legendCheckpoints",
			drawCallback: function(g, is_initial) {
				if (is_initial)
				{
					orig_xAxisRange = g.xAxisRange();
				}
				add_visibility_cb("Checkpoints", g, is_initial);
				add_export_button_callback("Checkpoints", g, is_initial, "Checkpoints");
			},
			
			zoomCallback: function(minDate, maxDate, yRanges) {
				zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this, 'checkpoints');
				if (this.isZoomed())
					sync_dateWindow(this, this.xAxisRange());
				else
					sync_dateWindow(this, orig_xAxisRange);
				synchronize_zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this);
			}
		}
	);
	
	var c_w_buffers = new Dygraph(
	    document.getElementById("chartWBuffers"),
	    "/server/{{instance.agent_address}}/{{instance.agent_port}}/supervision/data/w_buffers?start={{escape(start_date)}}&end={{escape(end_date)}}",
		{
			ylabel: "Written buffers",
			axisLabelFontSize: 10,
			yLabelWidth: 14,
			legend: "always",
			stackedGraph: true,
			labelsDiv: "legendWBuffers",
			drawCallback: function(g, is_initial) {
				if (is_initial)
				{
					orig_xAxisRange = g.xAxisRange();
				}
				add_visibility_cb("WBuffers", g, is_initial);
				add_export_button_callback("WBuffers", g, is_initial, "Written buffers");
			},
			
			zoomCallback: function(minDate, maxDate, yRanges) {
				zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this, 'w_buffers');
				if (this.isZoomed())
					sync_dateWindow(this, this.xAxisRange());
				else
					sync_dateWindow(this, orig_xAxisRange);
				synchronize_zoom(this.isZoomed(), epoch2pgtimestamp(minDate), epoch2pgtimestamp(maxDate), this);
			}
		}
	);
	
	
	sync_graphs = [
		{'dygraph': c_lvg, 'data': 'loadavg'},
		{'dygraph': c_cpu, 'data': 'cpu'},
		{'dygraph': c_memory, 'data': 'memory'},
		{'dygraph': c_swap, 'data': 'swap'},
		{'dygraph': c_tps, 'data': 'tps'},
		{'dygraph': c_dbs, 'data': 'db_size'},
		{'dygraph': c_sessions, 'data': 'sessions'},
		{'dygraph': c_blocks, 'data': 'blocks'},
		{'dygraph': c_hrr, 'data': 'hitreadratio'},
		{'dygraph': c_checkpoints, 'data': 'checkpoints'},
		{'dygraph': c_w_buffers, 'data': 'w_buffers'}
	];
/* end of customizable part */
});

function epoch2pgtimestamp(epoch_ms)
{
	var ndate = new Date(epoch_ms);
	var hh = (h=ndate.getHours())<10?('0'+h):h;
	var mm = (m=ndate.getMinutes())<10?('0'+m):m;
	var ss = (s=ndate.getSeconds())<10?('0'+s):s;
	return ndate.getFullYear()+'-'+(ndate.getMonth()+1)+'-'+ndate.getDate()+'T'+hh+':'+mm+':'+ss;
}


function add_visibility_cb(chart_id, g, is_initial)
{
	if (!is_initial)
		return;
	
	var nb_legend_item = 0;
	var visibility_html = ''
	var cb_ids = [];
	$('#legend'+chart_id).children('span').each(function() {
		visibility_html += '<input type="checkbox" id="'+chart_id+'CB'+nb_legend_item+'" checked>';
		visibility_html += '<label for="'+chart_id+'CB'+nb_legend_item+'"> '+$(this).text()+'</label>  ';
		cb_ids.push(chart_id+'CB'+nb_legend_item);
		nb_legend_item += 1;
	});
	$('#visibility'+chart_id).html(visibility_html);
	var nb = 0;
	for(var cb_id of cb_ids) {
		$('#'+cb_id).change(function() {
			g.setVisibility(parseInt($(this).attr('id').replace(chart_id+'CB', '')), $(this).is(':checked'));
		});
		nb += 1;
	}
}

function zoom(is_zoomed, start_date, end_date, g, data)
{
	var orig_start_date = '{{start_date}}';
	var orig_end_date = '{{end_date}}';
	var url_base = "/server/{{instance.agent_address}}/{{instance.agent_port}}/supervision/data/";
	if (!is_zoomed)
	{
		start_date = orig_start_date;
		end_date = orig_end_date;
	}
	g.updateOptions({
		file: url_base+data+"?start="+start_date+"&end="+end_date,
	}, false);
}

function synchronize_zoom(is_zoomed, start_date, end_date, g)
{
	var orig_start_date = '{{start_date}}';
	var orig_end_date = '{{end_date}}';
	var url_base = "/server/{{instance.agent_address}}/{{instance.agent_port}}/supervision/data/";
	var xaxisrange = null;
	for(var graph of sync_graphs)
	{
		if (graph['dygraph'] != g)
		{
			if (!is_zoomed)
			{
				start_date = orig_start_date;
				end_date = orig_end_date;
			}
			graph['dygraph'].updateOptions({
					file: url_base+graph['data']+"?start="+start_date+"&end="+end_date
				}, false);
		}
	}
}

function sync_dateWindow(g, xaxisrange)
{
	for(var graph of sync_graphs)
	{
		if (graph['dygraph'].toString() != g.toString())
		{
			graph['dygraph'].updateOptions({
				dateWindow: xaxisrange,
				isZoomedIgnoreProgrammaticZoom: false,
			}, true);
		}
	}
}

function add_export_button_callback(chart_id, g, is_initial, label)
{
	if (!is_initial)
		return;
	$('#buttonExport'+chart_id).click(function(){
		var options = {
			titleFont: "bold 18px verdana",
			titleFontColor: "black",
			axisLabelFont: "bold 14px verdana",
			axisLabelFontColor: "black",
			labelFont: "normal 12px verdana",
			labelFontColor: "black",
			legendFont: "bold 12px verdana",
			legendFontColor: "black",
			legendHeight: 20
		}; 
		var img = document.getElementById('imageModal');
		Dygraph.Export.asPNG(g, img, options);
		$('#ModalLabel').html(label);
		$('#Modal').modal('show');
	});
}
</script>

{% end %}
